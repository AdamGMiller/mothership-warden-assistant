<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mothership</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        font-family: "Courier New", monospace;
        background-color: #000;
        color: #33ff33;
        display: flex;
        height: 100%; /* Ensure body fills the entire page height */
        overflow: hidden; /* Prevent body scrolling */
      }

      .main-content {
        width: 80%;
        padding: 20px;
        border-right: 2px solid #33ff33;
        overflow-y: auto; /* Enable independent scrolling */
        height: 100%; /* Fill the entire page height */
      }

      .form-container {
        width: 20%;
        padding: 10px;
        display: flex;
        flex-direction: column;
        overflow-y: auto; /* Enable independent scrolling */
        height: 100%; /* Fill the entire page height */
        right: 0; /* Align to the right */
        top: 0; /* Align to the top */
      }

      .form-container h2 {
        font-size: 14px; /* Reduce font size */
        margin-bottom: 5px; /* Tighten spacing */
        text-transform: uppercase;
        border-bottom: 1px solid #33ff33;
        padding-bottom: 3px; /* Tighten spacing */
      }

      .form-container label {
        font-size: 10px; /* Reduce font size */
        margin-top: 5px; /* Tighten spacing */
        display: block;
      }

      .form-container input,
      .form-container select,
      .form-container button {
        width: 100%;
        margin-top: 3px; /* Tighten spacing */
        padding: 3px; /* Reduce padding */
        background-color: #222;
        color: #33ff33;
        border: 1px solid #33ff33;
        font-family: "Courier New", monospace;
        font-size: 10px; /* Reduce font size */
      }

      .form-container button {
        margin-top: 3px; /* Tighten spacing */
        cursor: pointer;
        text-transform: uppercase;
      }

      .form-container button.small-btn {
        width: 13px;
        height: 13px;
        padding: 0;
        margin: 0;
        font-size: 8px;
        font-weight: bold;
        line-height: 1;
        text-transform: none;
      }

      .player-list {
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        overflow-y: auto;
      }

      .player-card {
        width: 100%; /* Fill the full width of the column */
        border: 1px solid #33ff33;
        padding: 5px; /* Reduce padding */
        background-color: #111;
        display: flex;
        flex-direction: column;
        align-items: flex-start; /* Left align content */
        font-size: 10px; /* Reduce font size */
        cursor: pointer; /* Display hand cursor */
      }

      .player-card img {
        width: 80px; /* Smaller image */
        height: 80px;
        object-fit: cover;
        border: 1px solid #33ff33;
        margin-bottom: 5px; /* Reduce margin */
        align-self: center; /* Keep image centered */
      }

      .player-card h3 {
        font-size: 12px; /* Smaller font size */
        margin: 0;
        align-self: center; /* Keep title centered */
      }

      .player-card p {
        font-size: 10px; /* Smaller font size */
        margin: 2px 0; /* Reduce spacing */
      }

      .portrait-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
        gap: 5px;
        margin-top: 10px;
        border: 1px solid #33ff33;
        padding: 10px;
        background-color: #111;
      }

      .portrait-grid img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        cursor: pointer;
        border: 1px solid #33ff33;
      }

      .portrait-grid img:hover {
        border-color: #ff3333;
      }

      .selected-portrait {
        border-color: #ffcc00;
        box-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
      }

      .portrait-list {
        display: none;
        position: absolute;
        width: 80px; /* Narrow width to fit only one portrait plus padding */
        max-height: 50%;
        overflow-y: auto;
        background-color: #111;
        border: 1px solid #33ff33;
        padding: 10px;
        z-index: 1000;
      }

      .portrait-list img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        cursor: pointer;
        border: 1px solid #33ff33;
        margin: 5px 0; /* Only vertical margin */
        display: block; /* Make images block-level to stack vertically */
      }

      .portrait-list img:hover {
        border-color: #ff3333;
      }

      .area {
        margin-bottom: 20px;
      }

      .area h1 {
        cursor: pointer; /* Hand cursor for expand/collapse button */
        text-transform: uppercase;
        border-bottom: 1px solid #33ff33;
        padding-bottom: 5px;
      }

      .scene-images {
        display: none; /* Initially collapsed */
        margin-left: 10px;
      }

      .scene-image-container {
        text-align: center;
        margin: 10px;
      }

      .scene-image-container img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        cursor: pointer; /* Hand cursor on hover */
        margin-bottom: 5px;
      }

      .scene-image-container p {
        font-size: 12px;
        margin: 0;
        color: #33ff33;
      }

      /* Style the scrollbar for main-content */
      .main-content::-webkit-scrollbar {
        width: 10px; /* Width of the scrollbar */
      }

      .main-content::-webkit-scrollbar-track {
        background: #111; /* Dark background for the scrollbar track */
        border: 1px solid #33ff33; /* Green border around the track */
      }

      .main-content::-webkit-scrollbar-thumb {
        background: #33ff33; /* Green scrollbar thumb */
        border: 2px solid #111; /* Dark border around the thumb */
        border-radius: 5px; /* Rounded corners for the thumb */
      }

      .main-content::-webkit-scrollbar-thumb:hover {
        background: #66ff66; /* Lighter green when hovered */
      }

      .main-content::-webkit-scrollbar-thumb:active {
        background: #99ff99; /* Even lighter green when active */
      }

      .scenario-content {
        padding-bottom: 20px;
      }

      /* Add styles for the scenario select dropdown */
      #scenario-select {
        width: 100%;
        padding: 5px;
        background-color: #111;
        color: #33ff33;
        border: 1px solid #33ff33;
        font-family: "Courier New", monospace;
        font-size: 14px;
        text-transform: uppercase;
        margin-bottom: 10px;
        cursor: pointer;
      }

      #scenario-select:hover {
        border-color: #66ff66;
      }

      /* Add styles for the Open Player Page button */
      button#open-player-page {
        width: 100%;
        padding: 10px;
        background-color: #111;
        color: #33ff33;
        border: 2px solid #33ff33;
        font-family: "Courier New", monospace;
        font-size: 16px;
        text-transform: uppercase;
        cursor: pointer;
        margin-bottom: 20px;
        box-shadow: 0 0 10px #33ff33;
        transition: all 0.3s ease-in-out;
      }

      button#open-player-page:hover {
        background-color: #33ff33;
        color: #000;
        border-color: #66ff66;
        box-shadow: 0 0 15px #66ff66;
      }

      .scene-name {
        font-size: 18px;
        color: #33ff33;
        font-weight: 600;
      }

      .scene-description {
        border: 1px solid #33ff33;
        background-color: rgba(51, 255, 51, 0.1);
        padding: 10px;
        margin-bottom: 10px;
        cursor: pointer;
      }

      .attribution-link {
        color: #33ff33; /* Green color */
        font-weight: 400; /* 400 weight */
        text-decoration: none; /* Remove underline */
      }

      .attribution-link:hover {
        text-decoration: underline; /* Add underline on hover */
      }

      .scenario-header {
        margin-bottom: 20px;
        border-bottom: 1px solid #33ff33;
        padding-bottom: 10px;
      }

      .scenario-link {
        color: #33ff33;
        text-decoration: none;
        font-weight: bold;
        font-size: 24px;
      }

      .scenario-link:hover {
        text-decoration: underline;
      }

      .scenario-description {
        font-size: 14px;
        color: #33ff33;
        margin-top: 10px;
        line-height: 1.5;
      }

      @keyframes blink {
        0%,
        100% {
          color: #33ff33;
          font-weight: 600;
        }
        50% {
          color: #4b9a4b;
        }
      }

      #quick-start-instructions {
        display: none;
        margin-top: 20px;
        color: #33ff33;
        font-size: 14px;
        line-height: 1.5;
      }

      #quick-start-instructions strong {
        font-weight: bold;
      }

      #quick-start-instructions ul {
        margin: 0;
        padding-left: 20px;
      }

      #quick-start-instructions li {
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div class="main-content">
      <h1>Mothership Warden Assistant</h1>
      <label for="scenario-select">Select Scenario:</label>
      <select id="scenario-select" onchange="loadScenario()">
        <option value="ypsilon">The Haunting of Ypsilon 14</option>
      </select>

      <!-- Updated button with ID for styling -->
      <button id="open-player-page" onclick="openPlayerPage()">
        Open Player Page
      </button>

      <div
        id="quick-start-instructions"
        style="
          display: none;
          margin-top: 20px;
          color: #33ff33;
          font-size: 14px;
          line-height: 1.5;
        "
      >
        <strong>Quick Start:</strong>
        <ul style="margin: 0; padding-left: 20px">
          <li>
            Click <strong>Open Player Page</strong> to open the player page -
            move the browser tab to another monitor to show to players (hides
            these instructions).
          </li>
          <li>
            Click the scene titles below to expand, click on images to send to
            the player screen.
          </li>
          <li>
            Click on the player stats to edit them, click
            <strong>Add Player</strong> for more,
            <strong>Show Portraits</strong> to show all to the player. Changes
            will be saved.
          </li>
        </ul>
      </div>

      <div id="scenario-content" class="scenario-content">
        <!-- Scenario content will be dynamically added here -->
      </div>
    </div>
    <div class="form-container">
      <audio
        id="sound-player"
        controls
        style="width: 100%; margin-bottom: 10px"
      >
        <!-- Sound player for playing scene sounds -->
      </audio>
      <div
        id="current-sound"
        style="
          text-align: center;
          font-family: 'Courier New', monospace;
          color: #33ff33;
          margin-top: 5px;
        "
      >
        <!-- Current sound playing will be displayed here -->
      </div>
      <div style="border-bottom: 2px solid #33ff33; margin-bottom: 10px"></div>

      <div class="player-list" id="player-list">
        <!-- Player cards will be dynamically added here -->
      </div>

      <div class="player-edit-form" id="player-edit-form" style="display: none">
        <h2>Edit Player</h2>

        <input type="input" id="player-select" style="visibility: hidden" />

        <label for="player-name">Name:</label>
        <div style="display: flex; gap: 5px; align-items: center">
          <input id="player-name" type="text" />
          <input id="player-portrait" type="text" />
          <button
            id="portrait-dropdown-button"
            class="portrait-dropdown-button"
            onclick="togglePortraitList()"
          >
            ▼
          </button>
        </div>

        <div id="portrait-list" class="portrait-list">
          <!-- Portrait options will be dynamically added here -->
        </div>

        <label>Health and Stress:</label>
        <div style="display: flex; gap: 5px; align-items: center">
          <input
            id="player-current-health"
            type="number"
            maxlength="2"
            placeholder="Health"
          />
          <span>/</span>
          <input
            id="player-max-health"
            type="number"
            maxlength="2"
            placeholder="Max ♥"
          />
          <input
            id="player-current-stress"
            type="number"
            maxlength="2"
            placeholder="Stress"
          />
          <span>/</span>
          <input
            id="player-max-stress"
            type="number"
            maxlength="2"
            placeholder="Max"
          />
        </div>

        <label>Wounds:</label>
        <div style="display: flex; gap: 5px; align-items: center">
          <input
            id="player-current-wounds"
            type="number"
            maxlength="1"
            placeholder="Wounds"
          />
          <span>/</span>
          <input
            id="player-max-wounds"
            type="number"
            maxlength="1"
            placeholder="Max"
          />
        </div>

        <label>Status:</label>
        <div>
          <input
            id="player-status"
            type="text"
            placeholder="Status"
            style="width: 100%"
          />
        </div>

        <div
          style="display: flex; gap: 5px; align-items: center; margin-top: 10px"
        >
          <button onclick="removePlayer()" style="width: 80px">Remove</button>
          <button onclick="updatePlayer()">Update</button>
        </div>
      </div>

      <!-- Existing Add Player button -->
      <button id="add-player-button" onclick="addPlayer()">Add Player</button>

      <!-- New Show Portraits link -->
      <a
        id="show-portraits-link"
        href="#"
        onclick="sendShowPortraitsMessage()"
        style="
          color: #33ff33;
          text-decoration: none;
          margin-top: 10px;
          display: block;
        "
      >
        Show Portraits
      </a>
    </div>

    <script>
      const players = JSON.parse(localStorage.getItem("players")) || [
        {
          name: "Player 1",
          maxHealth: 15,
          maxWounds: 5,
          currentHealth: 15,
          currentWounds: 0,
          maxStress: 20,
          currentStress: 2,
          status: "Active",
          portrait: "Android1.png",
        },
      ];

      function savePlayersToLocalStorage() {
        localStorage.setItem("players", JSON.stringify(players));
      }

      function populatePortraitList() {
        const portraitList = document.getElementById("portrait-list");
        const prefixCounts = {
          Android: 17,
          Marine: 20,
          Teamster: 22,
          Scientist: 20,
        };

        portraitList.innerHTML = ""; // Clear existing options

        Object.entries(prefixCounts).forEach(([prefix, count]) => {
          for (let i = 1; i <= count; i++) {
            const img = document.createElement("img");
            img.src = `./portraits/thumbnails/${prefix}${i}.png`;
            img.alt = `${prefix}${i}`;
            img.onclick = () => selectPortrait(`${prefix}${i}.png`);
            portraitList.appendChild(img);
          }
        });
      }

      function togglePortraitList() {
        const portraitList = document.getElementById("portrait-list");
        const button = document.getElementById("portrait-dropdown-button");
        const rect = button.getBoundingClientRect();

        // Position the portrait list under the button
        //portraitList.style.top = `${rect.bottom + window.scrollY}px`;
        //portraitList.style.left = `${rect.left + window.scrollX}px`;

        // Toggle visibility
        portraitList.style.display =
          portraitList.style.display === "block" ? "none" : "block";

        // Add event listener to hide the list when clicking outside
        document.addEventListener("click", hidePortraitListOnClickOutside);
      }

      function hidePortraitListOnClickOutside(event) {
        const portraitList = document.getElementById("portrait-list");
        const button = document.getElementById("portrait-dropdown-button");

        // Check if the click is outside the portrait list and button
        if (!portraitList.contains(event.target) && event.target !== button) {
          portraitList.style.display = "none";
          document.removeEventListener("click", hidePortraitListOnClickOutside);
        }
      }

      function selectPortrait(portrait) {
        const portraitDisplay = document.getElementById(
          "player-portrait-display"
        );
        document.getElementById("player-portrait").value = portrait;

        // Hide the portrait list after selecting a portrait
        document.getElementById("portrait-list").style.display = "none";
      }

      function loadPlayerIntoForm(index) {
        const playerEditForm = document.getElementById("player-edit-form");
        const addPlayerButton = document.getElementById("add-player-button");
        const playerSelect = document.getElementById("player-select");
        const player = players[index];
        if (!player) {
          playerEditForm.style.display = "none"; // Hide the form if no player is selected
          addPlayerButton.style.display = "block"; // Show the Add Player button
          playerSelect.value = ""; // Clear the hidden input
          return;
        }

        playerEditForm.style.display = "block"; // Show the form when a player is selected
        addPlayerButton.style.display = "none"; // Hide the Add Player button
        playerSelect.value = index; // Set the hidden input to the selected player's index
        document.getElementById("player-name").value = player.name;
        document.getElementById("player-max-health").value = player.maxHealth;
        document.getElementById("player-current-health").value =
          player.currentHealth;
        document.getElementById("player-max-stress").value = player.maxStress;
        document.getElementById("player-current-stress").value =
          player.currentStress;
        document.getElementById("player-max-wounds").value = player.maxWounds;
        document.getElementById("player-current-wounds").value =
          player.currentWounds;
        document.getElementById("player-status").value = player.status;
        document.getElementById("player-portrait").value = player.portrait;
      }

      function selectPlayerByPortrait(name) {
        const index = players.findIndex((player) => player.name === name);
        if (index !== -1) {
          loadPlayerIntoForm(index);
        }
      }

      function removePlayer() {
        const playerSelect = document.getElementById("player-select");
        const index = playerSelect.value;
        const player = players[index];
        if (!player) return;

        const confirmation = confirm(
          `Are you sure you want to delete ${player.name}?`
        );
        if (confirmation) {
          players.splice(index, 1);
          savePlayersToLocalStorage();
          renderPlayers();
        }
      }

      function renderPlayers() {
        const playerList = document.getElementById("player-list");
        playerList.innerHTML = "";

        players.forEach((player, index) => {
          const playerCard = document.createElement("div");
          playerCard.className = "player-card";

          // Create the player image element
          const playerImage = document.createElement("img");
          playerImage.src = `./portraits/thumbnails/${player.portrait}`;
          playerImage.alt = `${player.name}`;
          playerImage.onclick = () =>
            sendImageToPlayerPage(`./portraits/${player.portrait}`); // Send image to player.html

          // Create the player text container
          const playerText = document.createElement("div");
          playerText.innerHTML = `
      <h3>${player.name}</h3>
    `;
          playerText.onclick = () => loadPlayerIntoForm(index); // Open player edit form

          // Create Health section with buttons
          const healthDiv = document.createElement("div");
          healthDiv.style.display = "flex";
          healthDiv.style.alignItems = "center";
          healthDiv.style.gap = "3px";
          healthDiv.style.fontSize = "10px";
          healthDiv.style.padding = "2px 0";

          const healthLabel = document.createElement("span");
          healthLabel.textContent = "Health: ";
          healthLabel.style.width = "50px";
          healthLabel.onclick = () => loadPlayerIntoForm(index);

          const healthValue = document.createElement("span");
          healthValue.textContent = `${player.currentHealth}/${player.maxHealth}`;
          healthValue.style.width = "35px";
          healthValue.onclick = () => loadPlayerIntoForm(index);

          const healthMinusBtn = document.createElement("button");
          healthMinusBtn.textContent = "-";
          healthMinusBtn.className = "small-btn";
          healthMinusBtn.onclick = (e) => {
            e.stopPropagation();
            adjustPlayerStatByIndex(index, "currentHealth", -1);
          };

          const healthPlusBtn = document.createElement("button");
          healthPlusBtn.textContent = "+";
          healthPlusBtn.className = "small-btn";
          healthPlusBtn.onclick = (e) => {
            e.stopPropagation();
            adjustPlayerStatByIndex(index, "currentHealth", 1);
          };

          healthDiv.appendChild(healthLabel);
          healthDiv.appendChild(healthValue);
          healthDiv.appendChild(healthMinusBtn);
          healthDiv.appendChild(healthPlusBtn);

          // Create Stress section with buttons
          const stressDiv = document.createElement("div");
          stressDiv.style.display = "flex";
          stressDiv.style.alignItems = "center";
          stressDiv.style.gap = "3px";
          stressDiv.style.fontSize = "10px";
          stressDiv.style.padding = "2px 0";

          const stressLabel = document.createElement("span");
          stressLabel.textContent = "Stress: ";
          stressLabel.style.width = "50px";
          stressLabel.onclick = () => loadPlayerIntoForm(index);

          const stressValue = document.createElement("span");
          stressValue.textContent = `${player.currentStress}/${player.maxStress}`;
          stressValue.style.width = "35px";
          stressValue.onclick = () => loadPlayerIntoForm(index);

          const stressMinusBtn = document.createElement("button");
          stressMinusBtn.textContent = "-";
          stressMinusBtn.className = "small-btn";
          stressMinusBtn.onclick = (e) => {
            e.stopPropagation();
            adjustPlayerStatByIndex(index, "currentStress", -1);
          };

          const stressPlusBtn = document.createElement("button");
          stressPlusBtn.textContent = "+";
          stressPlusBtn.className = "small-btn";
          stressPlusBtn.onclick = (e) => {
            e.stopPropagation();
            adjustPlayerStatByIndex(index, "currentStress", 1);
          };

          stressDiv.appendChild(stressLabel);
          stressDiv.appendChild(stressValue);
          stressDiv.appendChild(stressMinusBtn);
          stressDiv.appendChild(stressPlusBtn);

          // Create Wounds section with buttons
          const woundsDiv = document.createElement("div");
          woundsDiv.style.display = "flex";
          woundsDiv.style.alignItems = "center";
          woundsDiv.style.gap = "3px";
          woundsDiv.style.fontSize = "10px";
          woundsDiv.style.padding = "2px 0";

          const woundsLabel = document.createElement("span");
          woundsLabel.textContent = "Wounds: ";
          woundsLabel.style.width = "50px";
          woundsLabel.onclick = () => loadPlayerIntoForm(index);

          const woundsValue = document.createElement("span");
          woundsValue.textContent = `${player.currentWounds}/${player.maxWounds}`;
          woundsValue.style.width = "35px";
          woundsValue.onclick = () => loadPlayerIntoForm(index);

          const woundsMinusBtn = document.createElement("button");
          woundsMinusBtn.textContent = "-";
          woundsMinusBtn.className = "small-btn";
          woundsMinusBtn.onclick = (e) => {
            e.stopPropagation();
            adjustPlayerStatByIndex(index, "currentWounds", -1);
          };

          const woundsPlusBtn = document.createElement("button");
          woundsPlusBtn.textContent = "+";
          woundsPlusBtn.className = "small-btn";
          woundsPlusBtn.onclick = (e) => {
            e.stopPropagation();
            adjustPlayerStatByIndex(index, "currentWounds", 1);
          };

          woundsDiv.appendChild(woundsLabel);
          woundsDiv.appendChild(woundsValue);
          woundsDiv.appendChild(woundsMinusBtn);
          woundsDiv.appendChild(woundsPlusBtn);

          // Create Status section
          const statusDiv = document.createElement("div");
          statusDiv.style.fontSize = "10px";
          statusDiv.style.padding = "2px 0";
          statusDiv.innerHTML = `<p style="margin: 2px 0;">Status: ${player.status}</p>`;
          statusDiv.onclick = () => loadPlayerIntoForm(index);

          // Append all elements to the player text container
          playerText.appendChild(healthDiv);
          playerText.appendChild(stressDiv);
          playerText.appendChild(woundsDiv);
          playerText.appendChild(statusDiv);

          // Append the image and text to the player card
          playerCard.appendChild(playerImage);
          playerCard.appendChild(playerText);

          playerList.appendChild(playerCard);
        });

        // Hide the form if no player is selected
        const playerEditForm = document.getElementById("player-edit-form");
        const playerSelect = document.getElementById("player-select");
        if (!playerSelect.value) {
          playerEditForm.style.display = "none";
        }
      }

      function updatePlayer() {
        const index = document.getElementById("player-select").value;
        const player = players[index];
        if (!player) return;

        player.name = document.getElementById("player-name").value;
        player.maxHealth = parseInt(
          document.getElementById("player-max-health").value,
          10
        );
        player.maxWounds = parseInt(
          document.getElementById("player-max-wounds").value,
          10
        );
        player.currentHealth = parseInt(
          document.getElementById("player-current-health").value,
          10
        );
        player.currentWounds = parseInt(
          document.getElementById("player-current-wounds").value,
          10
        );
        player.maxStress = parseInt(
          document.getElementById("player-max-stress").value,
          10
        );
        player.currentStress = parseInt(
          document.getElementById("player-current-stress").value,
          10
        );
        player.status = document.getElementById("player-status").value;
        player.portrait = document.getElementById("player-portrait").value;

        savePlayersToLocalStorage();
        renderPlayers();
        sendPlayerInfoToPlayerPage();

        // Hide the form after updating
        document.getElementById("player-edit-form").style.display = "none";

        // Show the Add Player button after updating
        const addPlayerButton = document.getElementById("add-player-button");
        addPlayerButton.style.display = "block"; // Hide the Add Player button
      }

      function adjustPlayerStat(statName, delta) {
        const index = document.getElementById("player-select").value;
        const player = players[index];
        if (!player) return;

        // Map the statName to the correct property
        const statMap = {
          currentHealth: "currentHealth",
          currentStress: "currentStress",
        };

        const stat = statMap[statName];
        if (!stat) return;

        // Get the input element
        const inputElement = document.getElementById(
          `player-${statName.replace(/([A-Z])/g, "-$1").toLowerCase()}`
        );

        // Update the value
        let newValue = player[stat] + delta;

        // Clamp the value between 0 and max
        const maxStatMap = {
          currentHealth: "maxHealth",
          currentStress: "maxStress",
        };
        const maxStat = maxStatMap[statName];
        if (maxStat) {
          newValue = Math.max(0, Math.min(newValue, player[maxStat]));
        } else {
          newValue = Math.max(0, newValue);
        }

        // Update player object
        player[stat] = newValue;

        // Update input field
        inputElement.value = newValue;

        // Save and sync
        savePlayersToLocalStorage();
        renderPlayers();
        sendPlayerInfoToPlayerPage();
      }

      function adjustPlayerStatByIndex(index, statName, delta) {
        const player = players[index];
        if (!player) return;

        // Map the statName to the correct property
        const statMap = {
          currentHealth: "currentHealth",
          currentStress: "currentStress",
          currentWounds: "currentWounds",
        };

        const stat = statMap[statName];
        if (!stat) return;

        // Update the value
        let newValue = player[stat] + delta;

        // Clamp the value between 0 and max
        const maxStatMap = {
          currentHealth: "maxHealth",
          currentStress: "maxStress",
          currentWounds: "maxWounds",
        };
        const maxStat = maxStatMap[statName];
        if (maxStat) {
          newValue = Math.max(0, Math.min(newValue, player[maxStat]));
        } else {
          newValue = Math.max(0, newValue);
        }

        // Update player object
        player[stat] = newValue;

        // Update input field if form is open for this player
        const playerSelect = document.getElementById("player-select");
        if (playerSelect.value == index) {
          const inputElement = document.getElementById(
            `player-${statName.replace(/([A-Z])/g, "-$1").toLowerCase()}`
          );
          if (inputElement) {
            inputElement.value = newValue;
          }
        }

        // Save and sync
        savePlayersToLocalStorage();
        renderPlayers();
        sendPlayerInfoToPlayerPage();
      }

      function addPlayer() {
        players.push({
          name: "New Player",
          maxHealth: 15,
          maxWounds: 2,
          currentHealth: 15,
          currentWounds: 0,
          maxStress: 20,
          currentStress: 2,
          status: "",
          portrait: "Android1.png",
        });

        savePlayersToLocalStorage();
        renderPlayers();
      }

      function loadScenario() {
        const scenarioSelect = document.getElementById("scenario-select");
        const scenarioValue = scenarioSelect.value;

        // Save the selected scenario to local storage
        localStorage.setItem("selectedScenario", scenarioValue);

        // Load the scenario JSON file
        fetch(`./scenarios/${scenarioValue}/scenario.json`)
          .then((response) => {
            if (!response.ok) {
              throw new Error(`Failed to load scenario: ${scenarioValue}`);
            }
            return response.json();
          })
          .then((data) => {
            renderScenario(data);
          })
          .catch((error) => {
            console.error(error);
            document.getElementById("scenario-content").innerHTML =
              "<p>Error loading scenario.</p>";
          });
      }

      function getScenarioName() {
        // Get the scenario name from local storage or the select element
        const scenarioSelect = document.getElementById("scenario-select");
        const savedScenario = localStorage.getItem("selectedScenario");
        return savedScenario || scenarioSelect.value;
      }

      // Helper function to calculate bodyFocus number from a pointOfInterest target
      async function calculateBodyFocus(target, systemName) {
        try {
          const systemResponse = await fetch(
            `./scenarios/${getScenarioName()}/systems/${systemName}.json`
          );
          if (!systemResponse.ok) return 0;

          const systemData = await systemResponse.json();

          if (target.type === "planet") {
            // Find the planet index by name
            const planetIndex = systemData.planets.findIndex(
              (p) => p.name === target.name
            );
            if (planetIndex >= 0) {
              return planetIndex + 1; // bodyFocus is 1-indexed
            }
          } else if (target.type === "asteroid") {
            // Asteroid bodyFocus = planets.length + asteroidIndex + 1
            return systemData.planets.length + target.index + 1;
          } else if (target.type === "jumpPoint") {
            // Jump points use special value -1
            return -1;
          }
        } catch (error) {
          console.error("Error calculating bodyFocus:", error);
        }
        return 0;
      }

      function renderScenario(scenarioData) {
        const scenarioContent = document.getElementById("scenario-content");

        // Display scenario name, URL, and description
        scenarioContent.innerHTML = `
        <div class="scenario-header">
          <h1>
            <a href="${scenarioData.url}" target="_blank" class="scenario-link">${scenarioData.name}</a>
          </h1>
          <p class="scenario-description">${scenarioData.description}</p>
        </div>
      `;

        // Render areas
        scenarioData.areas.forEach((area) => {
          const areaDiv = document.createElement("div");
          areaDiv.className = "area";

          const areaHeader = document.createElement("h1");
          areaHeader.textContent = area.name;

          const arrowIcon = document.createElement("span");
          arrowIcon.textContent = "▼"; // Down arrow initially
          arrowIcon.style.marginLeft = "10px";
          arrowIcon.style.cursor = "pointer";

          areaHeader.appendChild(arrowIcon);

          areaHeader.onclick = () => {
            const isExpanded = areaDiv.dataset.expanded === "true";
            toggleArea(areaDiv);
            arrowIcon.textContent = isExpanded ? "▼" : "▲"; // Switch between down and up arrows
            areaDiv.dataset.expanded = isExpanded ? "false" : "true";
          };

          const sceneImagesDiv = document.createElement("div");
          sceneImagesDiv.className = "scene-images";

          area.scenes.forEach((scene) => {
            const sceneDiv = document.createElement("div");

            const sceneNameDiv = document.createElement("div");
            sceneNameDiv.className = "scene-name";
            sceneNameDiv.textContent = scene.name;

            const descriptionDiv = document.createElement("div");
            descriptionDiv.className = "scene-description";

            const sentences = scene.description.match(/[^.!?]+[.!?]/g) || [
              scene.description,
            ];
            const firstSentence = sentences[0];
            const hasMoreSentences = sentences.length > 1;

            const formattedDescription = scene.description
              .split("\n")
              .map((line) => `<p>${line}</p>`)
              .join("");

            descriptionDiv.innerHTML = `<p>${firstSentence}${
              hasMoreSentences ? " <strong>(more)</strong>" : ""
            }</p>`;
            descriptionDiv.dataset.fullDescription = formattedDescription;
            descriptionDiv.dataset.collapsed = "true";

            descriptionDiv.onclick = () => {
              const isCollapsed = descriptionDiv.dataset.collapsed === "true";
              descriptionDiv.innerHTML = isCollapsed
                ? descriptionDiv.dataset.fullDescription
                : `<p>${firstSentence}${
                    hasMoreSentences ? " <strong>(more)</strong>" : ""
                  }</p>`;
              descriptionDiv.dataset.collapsed = isCollapsed ? "false" : "true";
            };

            descriptionDiv.style.border = "1px solid #33ff33";
            descriptionDiv.style.backgroundColor = "rgba(51, 255, 51, 0.1)";
            descriptionDiv.style.padding = "10px";
            descriptionDiv.style.marginBottom = "10px";
            descriptionDiv.style.cursor = "pointer";

            sceneDiv.appendChild(sceneNameDiv);
            sceneDiv.appendChild(descriptionDiv);

            const imageFlexContainer = document.createElement("div");
            imageFlexContainer.style.display = "flex";
            imageFlexContainer.style.flexWrap = "wrap";
            imageFlexContainer.style.gap = "10px";

            scene.images.forEach((image) => {
              const imageContainer = document.createElement("div");
              const thumbnailPath = `./scenarios/${getScenarioName()}/scenes/thumbnails/${image}`;
              const imagePath = `./scenarios/${getScenarioName()}/scenes/${image}`;
              imageContainer.className = "scene-image-container";
              imageContainer.innerHTML = `
          <img src="${thumbnailPath}" alt="${image}" onclick="sendImageToPlayerPage('${imagePath}')">
          <p>${image}</p>
        `;
              imageFlexContainer.appendChild(imageContainer);
            });

            if (scene.sounds) {
              const soundLinksDiv = document.createElement("div");
              soundLinksDiv.style.marginTop = "10px";

              scene.sounds.forEach((sound) => {
                const soundLink = document.createElement("a");
                soundLink.href = "#";
                soundLink.textContent = `Play Sound: ${sound.sound}`;
                soundLink.style.display = "block";
                soundLink.style.color = "#33ff33";
                soundLink.onclick = (event) => {
                  event.preventDefault();
                  playSound(
                    `./scenarios/${getScenarioName()}/sounds/${sound.sound}`,
                    sound.loop
                  );
                };
                soundLinksDiv.appendChild(soundLink);
              });
              sceneDiv.appendChild(soundLinksDiv);
            }

            if (scene.maps) {
              const mapLinksDiv = document.createElement("div");
              mapLinksDiv.style.marginTop = "10px";

              scene.maps.forEach((mapImage) => {
                // Create the "open map locally" link
                const openLocalLink = document.createElement("a");
                openLocalLink.href = `map.html?map=./scenarios/${getScenarioName()}/maps/${mapImage}`;
                openLocalLink.textContent = "(open map locally)";
                openLocalLink.style.marginRight = "10px";
                openLocalLink.style.color = "#33ff33";
                openLocalLink.style.fontSize = "12px";
                openLocalLink.style.textDecoration = "underline";
                openLocalLink.target = "_blank";

                // Create the Show Map link
                const mapLink = document.createElement("a");
                mapLink.href = "#";
                mapLink.textContent = `Show Map: ${mapImage}`;
                mapLink.style.display = "inline-block";
                mapLink.style.color = "#33ff33";
                mapLink.style.marginRight = "10px";
                mapLink.onclick = (event) => {
                  event.preventDefault();
                  sendMapToPlayerPage(
                    `./scenarios/${getScenarioName()}/maps/${mapImage}`
                  );
                };

                // Append both links to the mapLinksDiv
                mapLinksDiv.appendChild(mapLink);
                mapLinksDiv.appendChild(openLocalLink);
              });

              sceneDiv.appendChild(mapLinksDiv);
            }

            if (scene.systems && Array.isArray(scene.systems)) {
              scene.systems.forEach(async (systemName) => {
                // Create container for system controls
                const systemDiv = document.createElement("div");
                systemDiv.style.margin = "10px 0";

                // Label for dropdown
                const label = document.createElement("label");
                label.textContent = `Show ${systemName} system to players: `;
                label.style.marginRight = "5px";
                label.style.fontSize = "12px";
                label.style.color = "#33ff33";

                // Create dropdown
                const dropdown = document.createElement("select");
                dropdown.style.marginRight = "10px";
                dropdown.style.background = "#000";
                dropdown.style.color = "#33ff33";
                dropdown.style.border = "1px solid #33ff33";
                dropdown.style.fontFamily = "Courier New, monospace";
                dropdown.style.padding = "4px 8px";
                dropdown.style.cursor = "pointer";

                // Add default "System Overview" option
                const defaultOption = document.createElement("option");
                defaultOption.value = "0";
                defaultOption.textContent = "System Overview";
                dropdown.appendChild(defaultOption);

                // Load system JSON to get pointsOfInterest
                try {
                  const systemResponse = await fetch(
                    `./scenarios/${getScenarioName()}/systems/${systemName}.json`
                  );
                  if (systemResponse.ok) {
                    const systemData = await systemResponse.json();

                    // Add pointsOfInterest to dropdown
                    if (
                      systemData.pointsOfInterest &&
                      Array.isArray(systemData.pointsOfInterest)
                    ) {
                      systemData.pointsOfInterest.forEach((poi) => {
                        const option = document.createElement("option");
                        option.value = JSON.stringify(poi.target);
                        option.textContent = poi.name;
                        dropdown.appendChild(option);
                      });
                    }
                  }
                } catch (error) {
                  console.error(`Error loading system ${systemName}:`, error);
                }

                // Create Display button
                const displayButton = document.createElement("button");
                displayButton.textContent = "Display";
                displayButton.style.background = "#000";
                displayButton.style.color = "#33ff33";
                displayButton.style.border = "1px solid #33ff33";
                displayButton.style.fontFamily = "Courier New, monospace";
                displayButton.style.cursor = "pointer";
                displayButton.style.padding = "4px 12px";

                // Handle button click
                displayButton.onclick = async () => {
                  if (window.playerWindow) {
                    const selectedValue = dropdown.value;
                    let bodyFocus = 0;

                    if (selectedValue !== "0") {
                      try {
                        const target = JSON.parse(selectedValue);
                        bodyFocus = await calculateBodyFocus(
                          target,
                          systemName
                        );
                      } catch (error) {
                        console.error("Error parsing target:", error);
                      }
                    }

                    window.playerWindow.postMessage(
                      {
                        action: "showSystem",
                        scenario: getScenarioName(),
                        systemName: systemName,
                        bodyFocus: bodyFocus,
                      },
                      "*"
                    );
                  }
                };

                systemDiv.appendChild(label);
                systemDiv.appendChild(dropdown);
                systemDiv.appendChild(displayButton);
                sceneDiv.appendChild(systemDiv);
              });
            }

            sceneDiv.appendChild(imageFlexContainer);
            sceneImagesDiv.appendChild(sceneDiv);
          });

          areaDiv.appendChild(areaHeader);
          areaDiv.appendChild(sceneImagesDiv);

          scenarioContent.appendChild(areaDiv);
        });

        const attributionDiv = document.createElement("div");
        attributionDiv.className = "attributions";
        attributionDiv.innerHTML = "<h1>Attributions</h1>";

        scenarioData.attributions.forEach((attribution) => {
          const attributionItem = document.createElement("p");
          attributionItem.innerHTML = `
      <strong>${attribution.name}</strong> - ${attribution.role} 
      (<a href="${attribution.contact}" class="attribution-link" target="_blank">${attribution.contact}</a>) 
      - License: ${attribution.license}`;
          attributionDiv.appendChild(attributionItem);
        });

        scenarioContent.appendChild(attributionDiv);
      }

      function toggleArea(areaDiv) {
        const sceneImagesDiv = areaDiv.querySelector(".scene-images");
        sceneImagesDiv.style.display =
          sceneImagesDiv.style.display === "block" ? "none" : "block";
      }

      function openPlayerPage() {
        // Open player.html in a new window
        window.playerWindow = window.open("./player.html", "PlayerPage");

        // Add a delay to ensure the playerWindow is fully loaded
        const checkWindowLoaded = setInterval(() => {
          if (
            window.playerWindow &&
            window.playerWindow.document.readyState === "complete"
          ) {
            clearInterval(checkWindowLoaded); // Stop checking once the page is loaded
            sendPlayerInfoToPlayerPage(); // Send player info after the page is fully loaded
          }
        }, 100); // Check every 100ms
      }

      function sendPlayerInfoToPlayerPage() {
        const players = JSON.parse(localStorage.getItem("players")) || [];
        if (window.playerWindow) {
          window.playerWindow.postMessage({ action: "players", players }, "*");
        }
      }

      function sendImageToPlayerPage(imageName) {
        if (window.playerWindow) {
          window.playerWindow.postMessage({ action: "image", imageName }, "*");
        }
      }

      function sendMapToPlayerPage(mapPath) {
        if (window.playerWindow) {
          window.playerWindow.postMessage({ action: "map", mapPath }, "*");
        }
      }

      function sendShowPortraitsMessage() {
        if (window.playerWindow) {
          window.playerWindow.postMessage({ action: "showPortraits" }, "*");
        }
      }

      function playSound(soundPath, loop = false) {
        const soundPlayer = document.getElementById("sound-player");
        const currentSound = document.getElementById("current-sound");

        soundPlayer.src = soundPath;
        soundPlayer.loop = loop;
        soundPlayer.play();

        // Display the current sound playing
        const soundFileName = soundPath.split("/").pop(); // Extract the file name from the path
        currentSound.textContent = `Now Playing: ${soundFileName}`;
      }

      // Load the selected scenario on page load
      document.addEventListener("DOMContentLoaded", () => {
        const savedScenario =
          localStorage.getItem("selectedScenario") || "ypsilon";
        document.getElementById("scenario-select").value = savedScenario;
        loadScenario();
      });

      // Populate portrait list on page load
      populatePortraitList();
      renderPlayers();

      // load the selected scenario
      loadScenario();

      // Check every second if the player page is opened
      setInterval(() => {
        const openPlayerPageButton =
          document.getElementById("open-player-page");
        const quickStartInstructions = document.getElementById(
          "quick-start-instructions"
        );

        if (!window.playerWindow || window.playerWindow.closed) {
          // Add animated arrows to the button
          openPlayerPageButton.innerHTML = `< < < Open Player Page < < <`;
          openPlayerPageButton.style.animation = "blink 1s infinite";

          // Show the instructions
          quickStartInstructions.style.display = "block";
        } else {
          // Restore the original button text
          openPlayerPageButton.innerHTML = "Open Player Page";
          openPlayerPageButton.style.animation = "none";

          // Hide the instructions
          quickStartInstructions.style.display = "none";
        }
      }, 1000);
    </script>
  </body>
</html>
